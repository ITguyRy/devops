<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Vagrant Provisioning</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://devopslibrary.com/lessons/vagrant-provisioning">
  <link rel="alternate" type="application/rss+xml" title="DevOps Library" href="http://devopslibrary.com/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">DevOps Library</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Vagrant Provisioning</h1>
    <p class="post-meta"><time datetime="2015-06-22T13:00:00-04:00" itemprop="datePublished">Jun 22, 2015</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <div class="video"><figure><iframe width="640" height="480" src="//www.youtube.com/embed/5tPykQsuMfE" frameborder="0" allowfullscreen=""></iframe></figure></div>

<p>Code: https://github.com/devopslibrary/IntroductionToVagrant/tree/master/Vagrant%20Provisioning</p>

<p>This is Samantha with the DevOps Library, and welcome to the fourth episode in our Vagrant course!  Today we’ll talk about Vagrant Provisioning, which will allow us to run “vagrant up”, and have the entire environment all the way down to the application stack fully configured.</p>

<p>First though, you may be wondering what the benefits of automated provisioning are, since it DOES add some extra work up front.  The most obvious benefit of course is ease of use, once you fully automate an environment, every person on the team can bring up a full copy by running a single line.  Even more important than that though is the f and reproducibility that automation brings with it, as every single deploy becomes identical.  You’ll finally get to stop hearing “Well it works on my machine”, and it also makes it so much easier to reproduce production problems in development for troubleshooting.  You’ll even be able to (and should) use the same scripts for spinning up a development environment as you do for spinning up production servers–making it extremely easy to test infrastructure changes.  This is commonly referred to as “Infrastructure as Code”, and at its best can lead to what is referred to as “Immutable Infrastructure”.  If you’re not familiar with that term, it essentially means that instead of SSHing or RDPing into your servers to fix them or deploy a new application, you simply destroy and spinup a brand new server, all completely automated.  While we could spend several episodes on each of these topics alone, just know that the upfront time expense of setting up automated provisioning is more than worth it.</p>

<p>Well let’s go ahead and get started.  Today we’re going to pretend that we have a simple website that needs to be hosted with Apache.  Hopefully if you’ve been following along so far, you’ve already set up an Ubuntu vagrant VM, and have a VagrantFile that looks similar to this.  If you don’t, just CD to an empty directory and create a file named “VagrantFile” with the same code.  Because it’s pretty hard to automate something without knowing how to do it manually, we’ll install Apache by hand first.  Before we run “Vagrant Up” however, we do need to add one more line to the VagrantFile:</p>

<p><code class="highlighter-rouge">config.vm.network "forwarded_port", guest: 80, host: 8080</code>
What this line does is automatically forward all traffic from port 80 on the VM to our host on port 8080. That way once we install Apache, we can access the website at http://localhost:8080 without needing to be within the VM.  Alright, go ahead and run Vagrant Up, followed by Vagrant SSH.  If the VM was already running before you added the line above, make sure you run Vagrant Destroy first so that it’s recreated from scratch.</p>

<p>Alright, you should now be SSH’d into our vanilla Ubuntu VM.  First let’s run</p>

<p><code class="highlighter-rouge">sudo –i</code>
to become root.  Now run <code class="highlighter-rouge">apt-get install apache2</code> to install Apache.  After that completes, on our host computer, let’s try to visit localhost:8080 from a web browser.</p>

<p>Pause</p>

<p>Look there’s the default apache page!  That’s awesome!  But we are obviously going to want to replace the default index.html with our own page.  If you’re familiar with running Apache on Ubuntu, you know we could just upload all of our website files to /var/www/html, but doesn’t uploading them every time we recreate the VM sound frustrating?  Thankfully Vagrant has something called “Shared Folders” between the host and the VM.  To see what we’re talking about, run:</p>

<p><code class="highlighter-rouge">rm –rf /var/www/html</code>
followed by</p>

<p><code class="highlighter-rouge">ln –fs /vagrant /var/www/html</code>
Now visit localhost:8080 again, what do you see now?  A VagrantFile?  What just happened?  The first line we ran simply deleted /var/www/html, as we don’t need it, and the second line created a symlink pointing /var/www/html to the /vagrant directory.  That directory is automatically shared between the host and the Vagrant VM, and is simply the folder that the VagrantFile resides in on the host.  Now you may be wondering, why is this useful?  Well, instead of using VI on our VM, go ahead and just create an index.html within our Vagrant folder from the host.  You can now edit it with any tools that you’d like, and the moment that you save it, we can immediately see the changes at localhost:8080.  While we’re just hosting a simple web page in this example, you can easily do the same thing with more complex applications, it’s all up to you.</p>

<p>Well we finally have our website configured, but we did have to do quite a few things by hand.  It’s time to finally get to automated provisioning!</p>

<p>Vagrant has a wide variety of “Provisioners” to choose from.  You can use anything from a simple shell script, to Puppet, Chef, Ansible, Salt, or even Docker for provisioning.  We’re going to go ahead and just use a shell script for now so that we can get going quickly.  Go ahead and run “Vagrant Destroy” to kill off our VM, then create a new file named webserver.sh.</p>

<p>Webserver.sh is going to be the shell script that we use to provision the server from start to finish, and to start things off, we just need to add one line to the top to specify the type of shell to use.  We’re using bash, so type</p>

<p><code class="highlighter-rouge"><span class="c">#!/usr/bin/env bash</span></code>
.  Now we need to add all of the manual steps we ran to configure the VM.  Add</p>

<p><code class="highlighter-rouge">apt-get install apache2 –y</code>
.  Notice we had to add a dash Y, the reason is because we aren’t going to be able to type yes during the provisioning, so the dash Y just tells apt-get to go ahead and install Apache without confirmation.  If you’d like to throw in an apt-get update and an apt-get upgrade, feel free to do so as well, that way we have the latest versions of all the packages.  The last step was to link /var/www/html to /vagrant, so go ahead and add the two lines we ran for that, then save the script.</p>

<p>We’re almost finished, we just need to add final line to our VagrantFile.  Type:</p>

<p><code class="highlighter-rouge">config.vm.provision "shell", path: "webserver.sh"</code>
This line is pretty simple, we’re just telling Vagrant to use shell as our provisioner, and giving it the path to our shell script.  You could just as easily use Chef, Puppet, or a handful of other options as well.  You can even use multiple provisioners, Vagrant will just run them in the order that they’re listed.  Well, let’s save our VagrantFile.  We’re finally ready to run “Vagrant Up”</p>

<p>Let’s watch the output as Vagrant spins up our new VM.  We can actually see it running each of the steps, and once it finally finishes, don’t even worry about SSHing into it.  Let’s just test it by opening up a web browser again and visiting localhost:8080 again.  Look!  There’s our website, completely configured from scratch without us even needing to login to the VM!!  While I know our example was extremely simple, deep down it really is the same process for any environment.  In a real life scenario, you’ll probably end up having Vagrant spin up multiple VMs, each with a different application and configuration, but overall it’s pretty simple.  I hope you’re starting to see the power of Vagrant, but there’s still so much more it can do.  In the next few episodes, we’ll be introducing advanced networking and how to model complex multi-machine environments.  Thank you so much for watching, see you again soon!</p>

  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">DevOps Library</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>DevOps Library</li>
          <li><a href="mailto:admin@devopslibrary.com">admin@devopslibrary.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/kenerwin88"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">kenerwin88</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/devopslibrary"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">devopslibrary</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Welcome to the DevOps Library!  We have the best videos for the best admins!
</p>
      </div>
    </div>

  </div>

</footer>
<!-- Piwik -->
<script type="text/javascript">
    var _paq = _paq || [];
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
    var u="//kendog15.piwikpro.com/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', 1]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
    })();
    </script>
<noscript><p><img src="//kendog15.piwikpro.com/piwik.php?idsite=1" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->


  </body>

</html>
